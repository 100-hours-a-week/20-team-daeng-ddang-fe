name: FE CI/CD

on:
  pull_request:
    branches: ["main", "dev"]
    paths-ignore:
      - ".github/workflows/rollback.yml"
  push:
    branches: ["main", "dev"]
    paths-ignore:
      - ".github/workflows/rollback.yml"
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: fe-ci-cd-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RELEASE_ID: ${{ github.sha }}
  ARTIFACT_FILE: next-standalone.tgz
  MESSAGE: >-
    ${{
      github.event.pull_request.title ||
      github.event.head_commit.message ||
      github.workflow
    }}

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    timeout-minutes: 15

    defaults:
      run:
        working-directory: daengdong

    # - PR: base branch ê¸°ì¤€(main=prod, dev=dev)
    # - push: ë¸Œëœì¹˜ ê¸°ì¤€(main=prod, dev=dev)
    environment:
      name: >-
        ${{
          (github.event_name == 'pull_request' && github.base_ref == 'main') && 'prod' ||
          (github.event_name == 'pull_request') && 'dev' ||
          (github.ref_name == 'main' && 'prod') ||
          'dev'
        }}

    steps:
      - name: Mark CI start
        id: ci_time
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"
        working-directory: .

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"
          cache-dependency-path: daengdong/pnpm-lock.yaml

      - name: Install
        id: time_install
        run: |
          start=$(date +%s)
          pnpm install --frozen-lockfile
          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: Lint
        id: time_lint
        run: |
          start=$(date +%s)
          pnpm lint
          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: Test (if present)
        id: time_test
        run: |
          start=$(date +%s)
          set -euo pipefail

          if pnpm -s run | grep -qE '^test'; then
            pnpm test
            result="ran"
          else
            result="skipped"
            echo "[INFO] No test script. Skipping."
          fi

          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"
          echo "result=${result}" >> "$GITHUB_OUTPUT"

      - name: Build
        id: time_build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: "1"
          NEXT_PUBLIC_API_BASE_URL: ${{ vars.NEXT_PUBLIC_API_BASE_URL }}
          NEXT_PUBLIC_NAVER_MAP_CLIENT_ID: ${{ vars.NEXT_PUBLIC_NAVER_MAP_CLIENT_ID }}
          NEXT_PUBLIC_USE_MOCK: ${{ vars.NEXT_PUBLIC_USE_MOCK }}
        run: |
          start=$(date +%s)
          pnpm build
          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: Package standalone artifact
        id: time_package
        run: |
          start=$(date +%s)
          set -euo pipefail

          # Next standalone ì‚°ì¶œë¬¼ ì¡´ì¬ í™•ì¸
          test -d .next/standalone
          test -d .next/static
          test -f .next/BUILD_ID

          rm -rf .artifact
          mkdir -p .artifact

          # 1) standalone ê²°ê³¼ë¬¼ ë³µì‚¬
          cp -a .next/standalone/* .artifact/

          # 2) .next ì „ì²´ë¥¼ ë³µì‚¬
          rm -rf .artifact/.next
          cp -a .next .artifact/.next

          # 3) public ë³µì‚¬
          [ -d public ] && cp -a public .artifact/public || true

          # 4) ì˜ì¡´ì„± ì„¤ì¹˜ìš© íŒŒì¼ ë³µì‚¬
          cp -a package.json .artifact/
          cp -a pnpm-lock.yaml .artifact/

          # 5) ì••ì¶•
          tar -czf ${{ env.ARTIFACT_FILE }} -C .artifact .

          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: next-standalone-${{ env.RELEASE_ID }}
          path: daengdong/${{ env.ARTIFACT_FILE }}
          if-no-files-found: error
          retention-days: 30

      - name: Mark CI end
        id: ci_time_end
        if: always()
        run: echo "end=$(date +%s)" >> "$GITHUB_OUTPUT"
        working-directory: .

      - name: Notify (CI)
        if: always()
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          MESSAGE: ${{ env.MESSAGE }}
          JOB_STATUS: ${{ job.status }}
          RELEASE_ID: ${{ env.RELEASE_ID }}
          ACTOR: ${{ github.actor }}
          ENV_NAME: >-
            ${{
              (github.event_name == 'pull_request' && github.base_ref == 'main') && 'prod' ||
              (github.event_name == 'pull_request') && 'dev' ||
              (github.ref_name == 'main' && 'prod') ||
              'dev'
            }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          TIMESTAMP: ${{ github.event.head_commit.timestamp || github.event.pull_request.updated_at }}
          CI_START: ${{ steps.ci_time.outputs.start }}
          CI_END: ${{ steps.ci_time_end.outputs.end }}
          INSTALL_S: ${{ steps.time_install.outputs.start }}
          INSTALL_E: ${{ steps.time_install.outputs.end }}
          TEST_S: ${{ steps.time_test.outputs.start }}
          LINT_S: ${{ steps.time_lint.outputs.start }}
          LINT_E: ${{ steps.time_lint.outputs.end }}
          TEST_E: ${{ steps.time_test.outputs.end }}
          TEST_RESULT: ${{ steps.time_test.outputs.result }}
          BUILD_S: ${{ steps.time_build.outputs.start }}
          BUILD_E: ${{ steps.time_build.outputs.end }}
          PKG_S: ${{ steps.time_package.outputs.start }}
          PKG_E: ${{ steps.time_package.outputs.end }}
        run: |
          set -euo pipefail

          # WEBHOOK ì—†ìœ¼ë©´ ìŠ¤í… ì¢…ë£Œ
          [ -z "${WEBHOOK:-}" ] && echo "âš ï¸ DISCORD_WEBHOOK_URLì´ ê³µë°±ì´ë¯€ë¡œ ë³¸ ë‹¨ê³„ë¥¼ ìŠ¤í‚µí•©ë‹ˆë‹¤." && exit 0

          # ì•ˆì „í•œ ì‚°ìˆ  ê³„ì‚°ìš© í•¨ìˆ˜
          dur() { local s="${1:-}" e="${2:-}"; [ -n "$s" ] && [ -n "$e" ] && echo $((e - s)) || echo 0; }

          install_sec="$(dur "${INSTALL_S:-}" "${INSTALL_E:-}")"
          lint_sec="$(dur "${LINT_S:-}" "${LINT_E:-}")"
          build_sec="$(dur "${BUILD_S:-}" "${BUILD_E:-}")"
          pkg_sec="$(dur "${PKG_S:-}" "${PKG_E:-}")"
          ci_seconds="$(dur "${CI_START:-}" "${CI_END:-}")"
          test_sec="$(dur "${TEST_S:-}" "${TEST_E:-}")"

          if [ "$JOB_STATUS" = "success" ]; then
            TITLE="âœ… [FE / ${ENV_NAME}] CI Success"
            COLOR=5763719
          else
            TITLE="âŒ [FE / ${ENV_NAME}] CI Failed"
            COLOR=15548997
          fi

          test_label="${test_sec}s"
          if [ "${TEST_RESULT}" = "skipped" ]; then
            test_label="skipped"
          fi

          # ê°œí–‰ ë¬¸ì ë° ë”°ì˜´í‘œ ì œê±°, 200ìë¡œ ìë¦„
          safe_msg=$(echo "$MESSAGE" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 200)

          JSON_PAYLOAD=$(cat <<JSON
          {
            "embeds": [
              {
                "title": "$TITLE",
                "url": "$RUN_URL",
                "color": $COLOR,
                "description": "${safe_msg}",
                "fields": [
                  {"name":"Release ID","value":"\`${RELEASE_ID}\`","inline":false},
                  {"name":"Actor","value":"${ACTOR}","inline":true},
                  {"name":"Total CI","value":"${ci_seconds}s","inline":true},

                  {"name":"Install","value":"${install_sec}s","inline":true},
                  {"name":"Lint","value":"${lint_sec}s","inline":true},
                  {"name":"Test","value":"${test_label}","inline":true},

                  {"name":"Build","value":"${build_sec}s","inline":true},
                  {"name":"Package","value":"${pkg_sec}s","inline":true}
                ],
                "timestamp": "$TIMESTAMP"
              }
            ]
          }
          JSON
          )

          curl -sS -X POST -H "Content-Type: application/json" --data-binary "$JSON_PAYLOAD" "$WEBHOOK" || true

  cd:
    name: CD
    runs-on: ubuntu-latest
    needs: ci
    timeout-minutes: 15

    # pushì¼ ë•Œë§Œ ë°°í¬
    if: github.event_name == 'push'

    environment:
      name: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}
    env:
      ENV_NAME: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}

    steps:
      - name: Mark CD start
        id: cd_time
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: next-standalone-${{ env.RELEASE_ID }}

      - name: Upload artifact to EC2
        id: scp
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          source: "${{ env.ARTIFACT_FILE }}"
          target: "/tmp"

      - name: Deploy
        id: deploy
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            set -euo pipefail

            ENV_NAME='${{ env.ENV_NAME }}'
            echo "ğŸŒ ${ENV_NAME} ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤."

            # === ì„¤ì • ë³€ìˆ˜ ===
            FRONTEND_DIR="${{ secrets.FRONTEND_DIR }}"
            RELEASES_DIR="${FRONTEND_DIR}/releases"
            RELEASE_DIR="${RELEASES_DIR}/${{ env.RELEASE_ID }}"
            CURRENT_LINK="${FRONTEND_DIR}/current"
            BACKUP_LINK="${FRONTEND_DIR}/backup"

            UPSTREAM_FILE="/etc/caddy/upstreams/frontend.caddy"
            BLUE_PORT=3000
            GREEN_PORT=3001

            echo "ğŸš€ ë°°í¬ ì‹œì‘: ${{ env.RELEASE_ID }}"

            # í´ë” ìƒì„±
            mkdir -p "${RELEASE_DIR}"

            # 1) ì§ì „ ë²„ì „ backup
            if [ -L "${CURRENT_LINK}" ] || [ -d "${CURRENT_LINK}" ]; then
              CURRENT_RELEASE="$(readlink -f "${CURRENT_LINK}" || true)"
              if [ -n "${CURRENT_RELEASE}" ] && [ -d "${CURRENT_RELEASE}" ]; then
                ln -sfn "${CURRENT_RELEASE}" "${BACKUP_LINK}"
              fi
            fi

            # 2) ìƒˆ ë¦´ë¦¬ì¦ˆ ì••ì¶• í•´ì œ
            tar -xzf "/tmp/${{ env.ARTIFACT_FILE }}" -C "${RELEASE_DIR}"
            rm -f "/tmp/${{ env.ARTIFACT_FILE }}"

            # 3) current êµì²´
            ln -sfn "${RELEASE_DIR}" "${CURRENT_LINK}"

            # 4) env ìƒì„±
            ENV_FILE="${CURRENT_LINK}/.env"
            cat > "${ENV_FILE}" <<EOF
            NAVER_MAP_CLIENT_SECRET=${{ secrets.NAVER_MAP_CLIENT_SECRET }}
            EOF
            chmod 600 "${ENV_FILE}"

            # 5) í¬íŠ¸ í™•ì¸ ë° ê²°ì •
            CURRENT_PORT="$(grep -Eo '127\.0\.0\.1:(3000|3001)' "${UPSTREAM_FILE}" | awk -F: '{print $2}' | head -n1 || true)"

            if [ -z "$CURRENT_PORT" ]; then
              echo "âŒ upstreamì—ì„œ í˜„ì¬ í™œì„± í¬íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "ğŸš¨ ì•ˆì „ì„ ìœ„í•´ ë¡¤ë°±ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              exit 1
            fi

            if [ "$CURRENT_PORT" = "$BLUE_PORT" ]; then
              TARGET_PORT="$GREEN_PORT"
            else
              TARGET_PORT="$BLUE_PORT"
            fi

            TARGET_NAME="daeng-frontend-${TARGET_PORT}"
            CURRENT_NAME="daeng-frontend-${CURRENT_PORT}"

            echo "ğŸ”µ í˜„ì¬ í™œì„± í¬íŠ¸: $CURRENT_PORT"
            echo "ğŸŸ¢ ë°°í¬ íƒ€ê²Ÿ í¬íŠ¸: $TARGET_PORT"

            # 6) íƒ€ê²Ÿ í¬íŠ¸ì˜ ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            PID_TO_KILL=$(lsof -ti :${TARGET_PORT} || true)
            if [ -n "$PID_TO_KILL" ]; then
              echo "ğŸ§¹ íƒ€ê²Ÿ í¬íŠ¸($TARGET_PORT)ì˜ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
              kill -9 $PID_TO_KILL || true
            fi

            # 7) ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (PM2)
            echo "ğŸš€ PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ (Port: $TARGET_PORT)..."

            pm2 delete "${TARGET_NAME}" 2>/dev/null || true

            cd "${CURRENT_LINK}"

            # ì˜ì¡´ì„± ì„¤ì¹˜ (pnpm ì ˆëŒ€ ê²½ë¡œë¡œ ì‹¤í–‰)
            PNPM="/home/ubuntu/.nvm/versions/node/v20.20.0/bin/pnpm"
            "$PNPM" -v
            "$PNPM" install --frozen-lockfile --prod

            PORT="${TARGET_PORT}" NODE_ENV=production pm2 start ./server.js --name "${TARGET_NAME}"
            pm2 save

            # 8) í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œì‘..."

            HEALTH_CHECK_URL="http://localhost:${TARGET_PORT}/terms"
            IS_HEALTHY=0

            for i in {1..10}; do
              sleep 2
              HTTP_CODE="$(curl -s -o /dev/null -w "%{http_code}" --max-time 2 "${HEALTH_CHECK_URL}" || true)"
              if [ "${HTTP_CODE}" == "200" ]; then
                echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
                IS_HEALTHY=1
                break
              else
                echo "â³ ì‹œì‘ ëŒ€ê¸° ì¤‘.... ($i/10) (Code: ${HTTP_CODE})"
              fi
            done

            # í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ ì‹œ ë°°í¬ ì¤‘ë‹¨
            if [ "$IS_HEALTHY" -ne 1 ]; then
              echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              pm2 delete "${TARGET_NAME}" || true
              exit 1
            fi

            # 9) íŠ¸ë˜í”½ ì „í™˜ (í¬íŠ¸ ìŠ¤ìœ„ì¹­)
            echo "ğŸ”„ Caddy ì—°ê²° ë³€ê²½ ì¤‘ (Port: ${CURRENT_PORT} â†’ ${TARGET_PORT})..."

            # íŒŒì¼ ì•ˆì— 3000/3001ì´ ì—¬ëŸ¬ë²ˆ ìˆì–´ë„ ì „ë¶€ êµì²´(ì •ê·œí™”)
            sed -i -E "s/127\.0\.0\.1:(3000|3001)/127.0.0.1:${TARGET_PORT}/g" "${UPSTREAM_FILE}"

            if caddy reload --config /etc/caddy/Caddyfile; then
              echo "ğŸ‰ ë°°í¬ ì„±ê³µ ë° íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ."

              # 10. êµ¬ë²„ì „ ì¢…ë£Œ
              echo "ğŸ›‘ êµ¬ë²„ì „ í”„ë¡œì„¸ìŠ¤ ì‚­ì œ (Port: $CURRENT_PORT)..."
              pm2 delete "${CURRENT_NAME}" || true
              pm2 save
            else
              echo "ğŸš¨ Caddy Reload ì‹¤íŒ¨! ë¡¤ë°±í•©ë‹ˆë‹¤."
              pm2 delete "${TARGET_NAME}" || true
              exit 1
            fi

            # 11) ì˜¤ë˜ëœ ë¦´ë¦¬ì¦ˆ ì •ë¦¬
            echo "ğŸ§¹ ì˜¤ë˜ëœ ë¦´ë¦¬ì¦ˆ ì •ë¦¬ ì¤‘..."
            cd "${RELEASES_DIR}" && ls -dt */ | tail -n +6 | xargs -r rm -rf --

      - name: Mark CD end
        id: cd_time_end
        if: always()
        run: echo "end=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Notify (CD)
        if: always()
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
          MESSAGE: ${{ env.MESSAGE }}
          JOB_STATUS: ${{ job.status }}
          RELEASE_ID: ${{ env.RELEASE_ID }}
          ACTOR: ${{ github.actor }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          TIMESTAMP: ${{ github.event.head_commit.timestamp }}
          CD_START: ${{ steps.cd_time.outputs.start }}
          CD_END: ${{ steps.cd_time_end.outputs.end }}
          SCP_OUTCOME: ${{ steps.scp.outcome }}
          DEPLOY_OUTCOME: ${{ steps.deploy.outcome }}
        run: |
          set -euo pipefail

          # WEBHOOK ì—†ìœ¼ë©´ ìŠ¤í… ì¢…ë£Œ
          [ -z "${WEBHOOK:-}" ] && echo "âš ï¸ DISCORD_WEBHOOK_URLì´ ê³µë°±ì´ë¯€ë¡œ ë³¸ ë‹¨ê³„ë¥¼ ìŠ¤í‚µí•©ë‹ˆë‹¤." && exit 0

          # ì•ˆì „í•œ ì‚°ìˆ  ê³„ì‚°ìš© í•¨ìˆ˜
          dur() { local s="${1:-}" e="${2:-}"; [ -n "$s" ] && [ -n "$e" ] && echo $((e - s)) || echo 0; }
          cd_seconds="$(dur "${CD_START:-}" "${CD_END:-}")"

          if [ "$JOB_STATUS" = "success" ]; then
            TITLE="âœ… [FE / ${ENV_NAME}] CD Success"
            COLOR=5763719
          else
            TITLE="âŒ [FE / ${ENV_NAME}] CD Failed"
            COLOR=15548997
          fi

          # ê°œí–‰ ë¬¸ì ë° ë”°ì˜´í‘œ ì œê±°, 200ìë¡œ ìë¦„
          safe_msg=$(echo "$MESSAGE" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 200)

          JSON_PAYLOAD=$(cat <<JSON
          {
            "embeds": [
              {
                "title": "$TITLE",
                "url": "${RUN_URL}",
                "color": $COLOR,
                "description": "${safe_msg}",
                "fields": [
                  {"name":"Release ID","value":"\`${RELEASE_ID}\`","inline":false},
                  {"name":"Actor","value":"${ACTOR}","inline":true},
                  {"name":"Total CD","value":"${cd_seconds}s","inline":true},

                  {"name":"Upload (SCP)","value":"${SCP_OUTCOME}","inline":true},
                  {"name":"Deploy (SSH)","value":"${DEPLOY_OUTCOME}","inline":true}
                ],
                "timestamp": "$TIMESTAMP"
              }
            ]
          }
          JSON
          )

          curl -sS -X POST -H "Content-Type: application/json" --data-binary "$JSON_PAYLOAD" "$WEBHOOK" || true
