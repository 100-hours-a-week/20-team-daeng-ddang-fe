name: FE CI/CD

on:
  pull_request:
    branches: ["main", "dev"]
  push:
    branches: ["main", "dev"]
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: fe-ci-cd-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  RELEASE_ID: ${{ github.sha }}
  ARTIFACT_FILE: next-standalone.tgz
  MESSAGE: >-
    ${{
      github.event.pull_request.title ||
      github.event.head_commit.message ||
      github.workflow
    }}

jobs:
  ci:
    name: CI
    runs-on: ubuntu-latest
    timeout-minutes: 15

    defaults:
      run:
        working-directory: daengdong
    
    # - PR: base branch 기준(main=prod, dev=dev)
    # - push: 브랜치 기준(main=prod, dev=dev)
    environment:
      name: >-
        ${{
          (github.event_name == 'pull_request' && github.base_ref == 'main') && 'prod' ||
          (github.event_name == 'pull_request') && 'dev' ||
          (github.ref_name == 'main' && 'prod') ||
          'dev'
        }}

    steps:
      - name: Mark CI start
        id: ci_time
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"
        working-directory: .

      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
          run_install: false

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "pnpm"
          cache-dependency-path: daengdong/pnpm-lock.yaml

      - name: Install
        id: time_install
        run: |
          start=$(date +%s)
          pnpm install --frozen-lockfile
          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: Lint
        id: time_lint
        run: |
          start=$(date +%s)
          pnpm lint
          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: Test (if present)
        id: time_test
        run: |
          start=$(date +%s)
          set -euo pipefail

          if pnpm -s run | grep -qE '^test'; then
            pnpm test
            result="ran"
          else
            result="skipped"
            echo "[INFO] No test script. Skipping."
          fi

          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"
          echo "result=${result}" >> "$GITHUB_OUTPUT"

      - name: Create env file for build
        run: |
          echo "NEXT_PUBLIC_API_BASE_URL=${{ secrets.API_BASE_URL || vars.API_BASE_URL }}" > .env

      - name: Build
        id: time_build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: "1"
        run: |
          start=$(date +%s)
          pnpm build
          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: Package standalone artifact
        id: time_package
        run: |
          start=$(date +%s)
          set -euo pipefail

          # Next standalone 산출물 존재 확인
          test -d .next/standalone
          test -d .next/static
          test -f .next/BUILD_ID

          rm -rf .artifact
          mkdir -p .artifact

          # 1) standalone 결과물 복사
          cp -a .next/standalone/* .artifact/

          # 2) .next 전체를 복사
          rm -rf .artifact/.next
          cp -a .next .artifact/.next

          # 3) public 복사
          [ -d public ] && cp -a public .artifact/public || true

          # 4) 압축
          tar -czf ${{ env.ARTIFACT_FILE }} -C .artifact .

          end=$(date +%s)
          echo "start=${start}" >> "$GITHUB_OUTPUT"
          echo "end=${end}" >> "$GITHUB_OUTPUT"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: next-standalone-${{ env.RELEASE_ID }}
          path: daengdong/${{ env.ARTIFACT_FILE }}
          if-no-files-found: error
          retention-days: 30
      
      - name: Mark CI end
        id: ci_time_end
        if: always()
        run: echo "end=$(date +%s)" >> "$GITHUB_OUTPUT"
        working-directory: .
      
      - name: Notify Discord (CI)
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          MESSAGE: ${{ env.MESSAGE }}
          JOB_STATUS: ${{ job.status }}
          RELEASE_ID: ${{ env.RELEASE_ID }}
          ACTOR: ${{ github.actor }}
          ENV_NAME: >-
            ${{
              (github.event_name == 'pull_request' && github.base_ref == 'main') && 'prod' ||
              (github.event_name == 'pull_request') && 'dev' ||
              (github.ref_name == 'main' && 'prod') ||
              'dev'
            }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          CI_START: ${{ steps.ci_time.outputs.start }}
          CI_END: ${{ steps.ci_time_end.outputs.end }}
          INSTALL_S: ${{ steps.time_install.outputs.start }}
          INSTALL_E: ${{ steps.time_install.outputs.end }}
          TEST_S: ${{ steps.time_test.outputs.start }}
          LINT_S: ${{ steps.time_lint.outputs.start }}
          LINT_E: ${{ steps.time_lint.outputs.end }}
          TEST_E: ${{ steps.time_test.outputs.end }}
          TEST_RESULT: ${{ steps.time_test.outputs.result }}
          BUILD_S: ${{ steps.time_build.outputs.start }}
          BUILD_E: ${{ steps.time_build.outputs.end }}
          PKG_S: ${{ steps.time_package.outputs.start }}
          PKG_E: ${{ steps.time_package.outputs.end }}
        run: |
          set -euo pipefail

          # DISCORD_WEBHOOK_URL 없으면 스텝 종료
          [ -z "${DISCORD_WEBHOOK_URL:-}" ] && echo "[WARN] DISCORD_WEBHOOK_URL is empty. Skip." && exit 0

          # 안전한 산술 계산용 함수
          dur() { local s="${1:-}" e="${2:-}"; [ -n "$s" ] && [ -n "$e" ] && echo $((e - s)) || echo 0; }

          install_sec="$(dur "${INSTALL_S:-}" "${INSTALL_E:-}")"
          lint_sec="$(dur "${LINT_S:-}" "${LINT_E:-}")"
          build_sec="$(dur "${BUILD_S:-}" "${BUILD_E:-}")"
          pkg_sec="$(dur "${PKG_S:-}" "${PKG_E:-}")"
          ci_seconds="$(dur "${CI_START:-}" "${CI_END:-}")"
          test_sec="$(dur "${TEST_S:-}" "${TEST_E:-}")"

          if [ "${JOB_STATUS}" = "success" ]; then color=5763719
          elif [ "${JOB_STATUS}" = "failure" ]; then color=15548997
          else color=9807270
          fi

          test_label="${test_sec}s"
          if [ "${TEST_RESULT}" = "skipped" ]; then
            test_label="skipped (${test_sec}s)"
          fi

          # 개행 문자 및 따옴표 제거, 200자로 자름
          safe_msg=$(echo "$MESSAGE" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 200)

          payload=$(cat <<JSON
          {
            "embeds": [
              {
                "title": "[FE / ${ENV_NAME}] CI ${JOB_STATUS}",
                "url": "${RUN_URL}",
                "color": ${color},
                "description": "${safe_msg}",
                "fields": [
                  {"name":"Release ID","value":"\`${RELEASE_ID}\`","inline":false},
                  {"name":"Actor","value":"${ACTOR}","inline":true},
                  {"name":"Total CI","value":"${ci_seconds}s","inline":true},

                  {"name":"Install","value":"${install_sec}s","inline":true},
                  {"name":"Lint","value":"${lint_sec}s","inline":true},
                  {"name":"Test","value":"${test_label}","inline":true},

                  {"name":"Build","value":"${build_sec}s","inline":true},
                  {"name":"Package","value":"${pkg_sec}s","inline":true}
                ],
                "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              }
            ]
          }
          JSON
          )

          curl -sS -X POST -H "Content-Type: application/json" --data-binary "$payload" "${DISCORD_WEBHOOK_URL}" >/dev/null

  cd:
    name: CD
    runs-on: ubuntu-latest
    needs: ci
    timeout-minutes: 15

    # push일 때만 배포
    if: github.event_name == 'push'

    environment:
      name: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}

    steps:
      - name: Mark CD start
        id: cd_time
        run: echo "start=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Download artifact
        uses: actions/download-artifact@v4
        with:
          name: next-standalone-${{ env.RELEASE_ID }}

      - name: Upload artifact to EC2
        id: scp
        uses: appleboy/scp-action@v1.0.0
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          source: "${{ env.ARTIFACT_FILE }}"
          target: "/tmp"
      
      - name: Deploy
        id: deploy
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            set -euo pipefail

            RELEASE_ID="${{ env.RELEASE_ID }}"
            FRONTEND_DIR="${{ secrets.FRONTEND_DIR }}"
            CURRENT_LINK="${FRONTEND_DIR}/current"
            BACKUP_LINK="${FRONTEND_DIR}/backup"
            RELEASE_DIR="${FRONTEND_DIR}/releases/${RELEASE_ID}"

            UPSTREAM_FILE="/etc/caddy/upstreams/frontend.caddy"
            BLUE_PORT=3000
            GREEN_PORT=3001
            BLUE_NAME="app-frontend-blue"
            GREEN_NAME="app-frontend-green"

            mkdir -p "${RELEASE_DIR}"

            # 1) 직전 버전 백업 (current가 가리키는 실제 경로)
            if [ -L "${CURRENT_LINK}" ] || [ -d "${CURRENT_LINK}" ]; then
              CURRENT_RELEASE="$(readlink -f "${CURRENT_LINK}" || true)"
              if [ -n "${CURRENT_RELEASE}" ] && [ -d "${CURRENT_RELEASE}" ]; then
                ln -sfn "${CURRENT_RELEASE}" "${BACKUP_LINK}"
              fi
            fi

            # 2) 새 릴리즈 압축 해제
            tar -xzf "/tmp/${{ env.ARTIFACT_FILE }}" -C "${RELEASE_DIR}"
            rm -f "/tmp/${{ env.ARTIFACT_FILE }}"

            # 3) current 교체
            ln -sfn "${RELEASE_DIR}" "${CURRENT_LINK}"

            # 4) 현재 활성 포트 확인
            active_port="$(grep -Eo '127\.0\.0\.1:(3000|3001)' "${UPSTREAM_FILE}" | awk -F: '{print $2}' || true)"

              # 초기 값 없으면 blue 활성화 상태라고 가정
            if [ -z "${active_port}" ]; then
              active_port="${BLUE_PORT}"
            fi

            if [ "${active_port}" = "${BLUE_PORT}" ]; then
              idle_port="${GREEN_PORT}"
              idle_name="${GREEN_NAME}"
              active_name="${BLUE_NAME}"
            else
              idle_port="${BLUE_PORT}"
              idle_name="${BLUE_NAME}"
              active_name="${GREEN_NAME}"
            fi

            echo "[INFO] active_port=${active_port}, idle_port=${idle_port}"

            # 5) 신규 버전 배포
            pm2 delete "${idle_name}" || true
            cd "${CURRENT_LINK}"

            PORT="${idle_port}" NODE_ENV=production pm2 start ./server.js --name "${idle_name}"
            pm2 save

            # 6) 헬스 체크
            health_path="/"
            max_wait=30

            echo "[INFO] health check: http://127.0.0.1:${idle_port}${health_path}"
            ok=0
            for i in $(seq 1 "${max_wait}"); do
              if curl -fsS "http://127.0.0.1:${idle_port}${health_path}" >/dev/null; then
                ok=1
                break
              fi
              sleep 1
            done

            if [ "${ok}" -ne 1 ]; then
              echo "[ERROR] new release health check failed. rollback (keep active)"
              pm2 delete "${idle_name}" || true
              exit 1
            fi

            # 7) sed로 upstream 파일 스위치
              # 파일 안에 3000/3001이 여러번 있어도 전부 교체(정규화)
            sed -i -E "s/127\.0\.0\.1:(3000|3001)/127.0.0.1:${idle_port}/g" "${UPSTREAM_FILE}"

            # 8) Caddy 리로드
            caddy reload --config /etc/caddy/Caddyfile

            echo "[INFO] switched upstream to ${idle_port}"
            
            # 9) 전환 성공 후, 기존(active) 프로세스 종료
            pm2 delete "${active_name}" || true
            pm2 save
            echo "[INFO] stopped old process: ${active_name}"

      - name: Mark CD end
        id: cd_time_end
        if: always()
        run: echo "end=$(date +%s)" >> "$GITHUB_OUTPUT"

      - name: Notify Discord (CD)
        if: always()
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          MESSAGE: ${{ env.MESSAGE }}
          ENV_NAME: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}
          CD_START: ${{ steps.cd_time.outputs.start }}
          CD_END: ${{ steps.cd_time_end.outputs.end }}
          JOB_STATUS: ${{ job.status }}
          RELEASE_ID: ${{ env.RELEASE_ID }}
          ACTOR: ${{ github.actor }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          SCP_OUTCOME: ${{ steps.scp.outcome }}
          DEPLOY_OUTCOME: ${{ steps.deploy.outcome }}
        run: |
          set -euo pipefail
      
          # DISCORD_WEBHOOK_URL 없으면 스텝 종료
          [ -z "${DISCORD_WEBHOOK_URL:-}" ] && echo "[WARN] DISCORD_WEBHOOK_URL is empty. Skip." && exit 0

          # 안전한 산술 계산용 함수
          dur() { local s="${1:-}" e="${2:-}"; [ -n "$s" ] && [ -n "$e" ] && echo $((e - s)) || echo 0; }
          cd_seconds="$(dur "${CD_START:-}" "${CD_END:-}")"

          if [ "${JOB_STATUS}" = "success" ]; then color=5763719
          elif [ "${JOB_STATUS}" = "failure" ]; then color=15548997
          else color=9807270
          fi

          # 개행 문자 및 따옴표 제거, 200자로 자름
          safe_msg=$(echo "$MESSAGE" | tr '\n' ' ' | sed 's/"/\\"/g' | head -c 200)

          payload=$(cat <<JSON
          {
            "embeds": [
              {
                "title": "[FE / ${ENV_NAME}] CD ${JOB_STATUS}",
                "url": "${RUN_URL}",
                "color": ${color},
                "description": "${safe_msg}",
                "fields": [
                  {"name":"Release ID","value":"\`${RELEASE_ID}\`","inline":false},
                  {"name":"Actor","value":"${ACTOR}","inline":true},
                  {"name":"Total CD","value":"${cd_seconds}s","inline":true},

                  {"name":"Upload (SCP)","value":"${SCP_OUTCOME}","inline":true},
                  {"name":"Deploy (SSH)","value":"${DEPLOY_OUTCOME}","inline":true}
                ],
                "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
              }
            ]
          }
          JSON
          )

          curl -sS -X POST -H "Content-Type: application/json" --data-binary "$payload" "${DISCORD_WEBHOOK_URL}" >/dev/null
