name: FE Rollback

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        options: [dev, prod]
        required: true
      release_id:
        description: "ë¡¤ë°±í•˜ë ¤ëŠ” ë²„ì „ (ë¯¸ì…ë ¥ ì‹œ backupìœ¼ë¡œ ìë™ ë¡¤ë°±)"
        required: false
        default: ""

jobs:
  rollback:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    timeout-minutes: 15

    steps:
      - name: Print inputs
        run: |
          echo "environment=${{ inputs.environment }}"
          echo "release_id=${{ inputs.release_id }}"

      - name: Checkout
        uses: actions/checkout@v4

      # 1) release_id ìˆìœ¼ë©´ íŠ¹ì • ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
      - name: Rollback to target release
        if: ${{ inputs.release_id != '' }}
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            set -euo pipefail
            echo "ğŸŒ ${{ inputs.environment }} ì„œë²„ì—ì„œ ${{ inputs.release_id }}ë¡œ ë¡¤ë°±ì„ ì§„í–‰í•©ë‹ˆë‹¤."

      # 2) release_id ì—†ìœ¼ë©´ backup ë§í¬ë¡œ ë¡¤ë°±
      - name: Rollback to backup link
        id: rollback_backup
        if: ${{ inputs.release_id == '' }}
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            set -euo pipefail

            echo "ğŸŒ ${{ inputs.environment }} ì„œë²„ì—ì„œ Backupìœ¼ë¡œ ë¡¤ë°±ì„ ì§„í–‰í•©ë‹ˆë‹¤."

            # === ì„¤ì • ë³€ìˆ˜ ===
            FRONTEND_DIR="${{ secrets.FRONTEND_DIR }}"
            RELEASES_DIR="${FRONTEND_DIR}/releases"
            CURRENT_LINK="${FRONTEND_DIR}/current"
            BACKUP_LINK="${FRONTEND_DIR}/backup"
            UPSTREAM_FILE="/etc/caddy/upstreams/frontend.caddy"
            BLUE_PORT=3000
            GREEN_PORT=3001

            # 1) backup, current ì‹¬ë³¼ë¦­ ë§í¬ ìŠ¤ì™€í•‘
            BACKUP_RELEASE="$(readlink -f "${BACKUP_LINK}")"
            CURRENT_RELEASE="$(readlink -f "${CURRENT_LINK}")"
            ln -sfn "${BACKUP_RELEASE}" "${CURRENT_LINK}"
            ln -sfn "${CURRENT_RELEASE}" "${BACKUP_LINK}"

            # 2) env ìƒì„±
            ENV_FILE="${CURRENT_LINK}/.env"
            cat > "${ENV_FILE}" <<EOF
            NAVER_MAP_CLIENT_SECRET=${{ secrets.NAVER_MAP_CLIENT_SECRET }}
            EOF
            chmod 600 "${ENV_FILE}"

            # 3) í¬íŠ¸ í™•ì¸ ë° ê²°ì •
            CURRENT_PORT="$(grep -Eo '127\.0\.0\.1:(3000|3001)' "${UPSTREAM_FILE}" | awk -F: '{print $2}' | head -n1 || true)"

            if [ -z "$CURRENT_PORT" ]; then
              echo "âŒ upstreamì—ì„œ í˜„ì¬ í™œì„± í¬íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "ğŸš¨ ì•ˆì „ì„ ìœ„í•´ ë¡¤ë°±ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              exit 1
            fi

            if [ "$CURRENT_PORT" = "$BLUE_PORT" ]; then
              TARGET_PORT="$GREEN_PORT"
            else
              TARGET_PORT="$BLUE_PORT"
            fi

            TARGET_NAME="daeng-frontend-${TARGET_PORT}"
            CURRENT_NAME="daeng-frontend-${CURRENT_PORT}"

            echo "ğŸ”µ í˜„ì¬ í™œì„± í¬íŠ¸: $CURRENT_PORT"
            echo "ğŸŸ¢ ë°°í¬ íƒ€ê²Ÿ í¬íŠ¸: $TARGET_PORT"

            # 4) íƒ€ê²Ÿ í¬íŠ¸ì˜ ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            PID_TO_KILL=$(lsof -ti :${TARGET_PORT} || true)
            if [ -n "$PID_TO_KILL" ]; then
              echo "ğŸ§¹ íƒ€ê²Ÿ í¬íŠ¸($TARGET_PORT)ì˜ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
              kill -9 $PID_TO_KILL || true
            fi

            # 5) ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (PM2)
            echo "ğŸš€ PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ (Port: $TARGET_PORT)..."

            pm2 delete "${TARGET_NAME}" 2>/dev/null || true

            cd "${CURRENT_LINK}"
            PORT="${TARGET_PORT}" NODE_ENV=production pm2 start ./server.js --name "${TARGET_NAME}" --update-env
            pm2 save

            # 6) í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œì‘..."

            HEALTH_CHECK_URL="http://localhost:${TARGET_PORT}/terms"
            IS_HEALTHY=0

            for i in {1..10}; do
              sleep 2
              HTTP_CODE="$(curl -s -o /dev/null -w "%{http_code}" --max-time 2 "${HEALTH_CHECK_URL}" || true)"
              if [ "${HTTP_CODE}" == "200" ]; then
                echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
                IS_HEALTHY=1
                break
              else
                echo "â³ ì‹œì‘ ëŒ€ê¸° ì¤‘.... ($i/10) (Code: ${HTTP_CODE})"
              fi
            done

            # í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ ì‹œ ë°°í¬ ì¤‘ë‹¨
            if [ "$IS_HEALTHY" -ne 1 ]; then
              echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              pm2 delete "${TARGET_NAME}" || true
              exit 1
            fi

            # 7) íŠ¸ë˜í”½ ì „í™˜ (í¬íŠ¸ ìŠ¤ìœ„ì¹­)
            echo "ğŸ”„ Caddy ì—°ê²° ë³€ê²½ ì¤‘ (Port: ${CURRENT_PORT} â†’ ${TARGET_PORT})..."

            # íŒŒì¼ ì•ˆì— 3000/3001ì´ ì—¬ëŸ¬ë²ˆ ìˆì–´ë„ ì „ë¶€ êµì²´(ì •ê·œí™”)
            sed -i -E "s/127\.0\.0\.1:(3000|3001)/127.0.0.1:${TARGET_PORT}/g" "${UPSTREAM_FILE}"

            if caddy reload --config /etc/caddy/Caddyfile; then
              echo "ğŸ‰ ë°°í¬ ì„±ê³µ ë° íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ."

              # 8. êµ¬ë²„ì „ ì¢…ë£Œ
              echo "ğŸ›‘ êµ¬ë²„ì „ í”„ë¡œì„¸ìŠ¤ ì‚­ì œ (Port: $CURRENT_PORT)..."
              pm2 delete "${CURRENT_NAME}" || true
              pm2 save
            else
              echo "ğŸš¨ Caddy Reload ì‹¤íŒ¨! ë¡¤ë°±í•©ë‹ˆë‹¤."
              pm2 delete "${TARGET_NAME}" || true
              exit 1
            fi

            # ì˜¤ë˜ëœ ë¦´ë¦¬ì¦ˆ ì •ë¦¬
            echo "ğŸ§¹ ì˜¤ë˜ëœ ë¦´ë¦¬ì¦ˆ ì •ë¦¬ ì¤‘..."
            cd "${RELEASES_DIR}" && ls -dt */ | tail -n +6 | xargs -r rm -rf --

      - name: Notify Discord
        if: always()
        env:
          JOB_STATUS: ${{ job.status }}
          RELEASE_ID: ${{ inputs.release_id || 'backup' }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ACTOR: ${{ github.actor }}
          BRANCH: ${{ github.ref_name }}
          STARTED_AT: ${{ github.run_started_at }}
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -euo pipefail

          if [ "$JOB_STATUS" = "success" ]; then
            TITLE="âœ… [FE] Rollback Success"
            COLOR=5763719
          else
            TITLE="âŒ [FE] Rollback Failed"
            COLOR=15548997
          fi

          curl -H "Content-Type: application/json" \
            -d "{
              \"embeds\": [{
                \"title\": \"$TITLE\",
                \"url\": \"$RUN_URL\",
                \"color\": $COLOR,
                \"fields\": [
                  {\"name\": \"Release ID\", \"value\": \"\`$RELEASE_ID\`\", \"inline\": true},
                  {\"name\": \"Actor\", \"value\": \"$ACTOR\", \"inline\": true},
                  {\"name\": \"Branch\", \"value\": \"$BRANCH\", \"inline\": true}
                ],
                \"timestamp\": \"$STARTED_AT\"
              }]
            }" \
            "$WEBHOOK"
