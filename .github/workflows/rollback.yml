name: FE Rollback

on:
  workflow_dispatch:
    inputs:
      release_id:
        description: "ë¡¤ë°±í•˜ë ¤ëŠ” ë²„ì „ (ë¯¸ì…ë ¥ ì‹œ backupìœ¼ë¡œ ìë™ ë¡¤ë°±)"
        required: false
        default: ""

jobs:
  guard:
    name: Guard
    runs-on: ubuntu-latest
    steps:
      - run: |
          if [[ "${GITHUB_REF_NAME}" != "main" && "${GITHUB_REF_NAME}" != "dev" ]]; then
            echo "âŒ main í˜¹ì€ dev ë¸Œëœì¹˜ì— ëŒ€í•´ì„œë§Œ ë¡¤ë°± ì›Œí¬í”Œë¡œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            exit 1
          fi

  prepare:
    name: Prepare
    runs-on: ubuntu-latest
    needs: guard
    environment: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}
    env:
      ENV_NAME: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}
    timeout-minutes: 5

    steps:
      - name: Print inputs
        run: |
          echo "environment=$ENV_NAME"
          echo "release_id=${{ inputs.release_id || 'backup' }}"

      # 1) release_id ìˆìœ¼ë©´ íŠ¹ì • ë²„ì „ìœ¼ë¡œ ë¡¤ë°±
      - name: Prepare rollback to target release
        if: ${{ inputs.release_id != '' }}
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            set -euo pipefail

            ENV_NAME='${{ env.ENV_NAME }}'
            echo "ğŸŒ $ENV_NAME ì„œë²„ì—ì„œ ${{ inputs.release_id }}ë¡œ ë¡¤ë°±ì„ ì§„í–‰í•©ë‹ˆë‹¤."

            # === ì„¤ì • ë³€ìˆ˜ ===
            FRONTEND_DIR="${{ secrets.FRONTEND_DIR }}"
            RELEASES_DIR="${FRONTEND_DIR}/releases"
            RELEASE_DIR="${RELEASES_DIR}/${{ inputs.release_id }}"
            CURRENT_LINK="${FRONTEND_DIR}/current"
            BACKUP_LINK="${FRONTEND_DIR}/backup"

            # 1) release_id ì¡´ì¬ ìœ ë¬´ í™•ì¸ (ì—†ìœ¼ë©´ ì¢…ë£Œ)
            if [ ! -d "${RELEASE_DIR}" ]; then
              echo "âŒ ì§€ì •í•œ release_id ë””ë ‰í† ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤: ${RELEASE_DIR}"
              echo "ğŸ“Œ releases ëª©ë¡:"
              ls -Alt "${RELEASES_DIR}" || true
              exit 1
            fi

            # 2) CURRENT_LINKì´ ê°€ë¦¬í‚¤ëŠ” ì‹¤ì œ ê²½ë¡œë¥¼ BACKUP_LINKë¡œ, RELEASE_DIRì„ CURRENT_LINKë¡œ êµì²´
            CURRENT_RELEASE="$(readlink -f "${CURRENT_LINK}")"
            TARGET_RELEASE="$(readlink -f "${RELEASE_DIR}")"

            if [ "${CURRENT_RELEASE}" = "${TARGET_RELEASE}" ]; then
              echo "â„¹ï¸ ë°±ì—…í•˜ë ¤ëŠ” ë²„ì „ê³¼ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ë²„ì „ì´ ë™ì¼í•©ë‹ˆë‹¤."
              exit 0
            fi

            ln -sfn "${CURRENT_RELEASE}" "${BACKUP_LINK}"
            ln -sfn "${TARGET_RELEASE}" "${CURRENT_LINK}"

      # 2) release_id ì—†ìœ¼ë©´ backup ë§í¬ë¡œ ë¡¤ë°±
      - name: Prepare rollback to backup link
        if: ${{ inputs.release_id == '' }}
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            set -euo pipefail

            ENV_NAME='${{ env.ENV_NAME }}'
            echo "ğŸŒ $ENV_NAME ì„œë²„ì—ì„œ Backupìœ¼ë¡œ ë¡¤ë°±ì„ ì§„í–‰í•©ë‹ˆë‹¤."

            # === ì„¤ì • ë³€ìˆ˜ ===
            FRONTEND_DIR="${{ secrets.FRONTEND_DIR }}"
            CURRENT_LINK="${FRONTEND_DIR}/current"
            BACKUP_LINK="${FRONTEND_DIR}/backup"

            # 1) backup, current ì‹¬ë³¼ë¦­ ë§í¬ ìŠ¤ì™€í•‘
            BACKUP_RELEASE="$(readlink -f "${BACKUP_LINK}")"
            CURRENT_RELEASE="$(readlink -f "${CURRENT_LINK}")"
            ln -sfn "${BACKUP_RELEASE}" "${CURRENT_LINK}"
            ln -sfn "${CURRENT_RELEASE}" "${BACKUP_LINK}"

  perform:
    name: Perform
    runs-on: ubuntu-latest
    needs: [guard, prepare]
    environment: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}
    timeout-minutes: 15

    steps:
      - name: Perform Rollback
        uses: appleboy/ssh-action@v1.2.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          port: ${{ secrets.EC2_PORT }}
          script: |
            set -euo pipefail

            # === ì„¤ì • ë³€ìˆ˜ ===
            FRONTEND_DIR="${{ secrets.FRONTEND_DIR }}"
            RELEASES_DIR="${FRONTEND_DIR}/releases"
            CURRENT_LINK="${FRONTEND_DIR}/current"
            BACKUP_LINK="${FRONTEND_DIR}/backup"
            UPSTREAM_FILE="/etc/caddy/upstreams/frontend.caddy"
            BLUE_PORT=3000
            GREEN_PORT=3001

            # 1) env ìƒì„±
            ENV_FILE="${CURRENT_LINK}/.env"
            cat > "${ENV_FILE}" <<EOF
            NAVER_MAP_CLIENT_SECRET=${{ secrets.NAVER_MAP_CLIENT_SECRET }}
            EOF
            chmod 600 "${ENV_FILE}"

            # 2) í¬íŠ¸ í™•ì¸ ë° ê²°ì •
            CURRENT_PORT="$(grep -Eo '127\.0\.0\.1:(3000|3001)' "${UPSTREAM_FILE}" | awk -F: '{print $2}' | head -n1 || true)"

            if [ -z "$CURRENT_PORT" ]; then
              echo "âŒ upstreamì—ì„œ í˜„ì¬ í™œì„± í¬íŠ¸ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
              echo "ğŸš¨ ì•ˆì „ì„ ìœ„í•´ ë¡¤ë°±ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              exit 1
            fi

            if [ "$CURRENT_PORT" = "$BLUE_PORT" ]; then
              TARGET_PORT="$GREEN_PORT"
            else
              TARGET_PORT="$BLUE_PORT"
            fi

            TARGET_NAME="daeng-frontend-${TARGET_PORT}"
            CURRENT_NAME="daeng-frontend-${CURRENT_PORT}"

            echo "ğŸ”µ í˜„ì¬ í™œì„± í¬íŠ¸: $CURRENT_PORT"
            echo "ğŸŸ¢ ë°°í¬ íƒ€ê²Ÿ í¬íŠ¸: $TARGET_PORT"

            # 3) íƒ€ê²Ÿ í¬íŠ¸ì˜ ì¢€ë¹„ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬
            PID_TO_KILL=$(lsof -ti :${TARGET_PORT} || true)
            if [ -n "$PID_TO_KILL" ]; then
              echo "ğŸ§¹ íƒ€ê²Ÿ í¬íŠ¸($TARGET_PORT)ì˜ ê¸°ì¡´ í”„ë¡œì„¸ìŠ¤ ì •ë¦¬..."
              kill -9 $PID_TO_KILL || true
            fi

            # 4) ìƒˆ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰ (PM2)
            echo "ğŸš€ PM2ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ (Port: $TARGET_PORT)..."

            pm2 delete "${TARGET_NAME}" 2>/dev/null || true

            cd "${CURRENT_LINK}"
            PORT="${TARGET_PORT}" NODE_ENV=production pm2 start ./server.js --name "${TARGET_NAME}" --update-env
            pm2 save

            # 5) í—¬ìŠ¤ì²´í¬
            echo "ğŸ¥ í—¬ìŠ¤ ì²´í¬ ì‹œì‘..."

            HEALTH_CHECK_URL="http://localhost:${TARGET_PORT}/terms"
            IS_HEALTHY=0

            for i in {1..10}; do
              sleep 2
              HTTP_CODE="$(curl -s -o /dev/null -w "%{http_code}" --max-time 2 "${HEALTH_CHECK_URL}" || true)"
              if [ "${HTTP_CODE}" == "200" ]; then
                echo "âœ… í—¬ìŠ¤ ì²´í¬ ì„±ê³µ!"
                IS_HEALTHY=1
                break
              else
                echo "â³ ì‹œì‘ ëŒ€ê¸° ì¤‘.... ($i/10) (Code: ${HTTP_CODE})"
              fi
            done

            # í—¬ìŠ¤ì²´í¬ ì‹¤íŒ¨ ì‹œ ë°°í¬ ì¤‘ë‹¨
            if [ "$IS_HEALTHY" -ne 1 ]; then
              echo "âŒ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨. ë°°í¬ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
              pm2 delete "${TARGET_NAME}" || true
              exit 1
            fi

            # 6) íŠ¸ë˜í”½ ì „í™˜ (í¬íŠ¸ ìŠ¤ìœ„ì¹­)
            echo "ğŸ”„ Caddy ì—°ê²° ë³€ê²½ ì¤‘ (Port: ${CURRENT_PORT} â†’ ${TARGET_PORT})..."

            # íŒŒì¼ ì•ˆì— 3000/3001ì´ ì—¬ëŸ¬ë²ˆ ìˆì–´ë„ ì „ë¶€ êµì²´(ì •ê·œí™”)
            sed -i -E "s/127\.0\.0\.1:(3000|3001)/127.0.0.1:${TARGET_PORT}/g" "${UPSTREAM_FILE}"

            if caddy reload --config /etc/caddy/Caddyfile; then
              echo "ğŸ‰ ë°°í¬ ì„±ê³µ ë° íŠ¸ë˜í”½ ì „í™˜ ì™„ë£Œ."

              # 7. êµ¬ë²„ì „ ì¢…ë£Œ
              echo "ğŸ›‘ êµ¬ë²„ì „ í”„ë¡œì„¸ìŠ¤ ì‚­ì œ (Port: $CURRENT_PORT)..."
              pm2 delete "${CURRENT_NAME}" || true
              pm2 save
            else
              echo "ğŸš¨ Caddy Reload ì‹¤íŒ¨! ë¡¤ë°±í•©ë‹ˆë‹¤."
              pm2 delete "${TARGET_NAME}" || true
              exit 1
            fi

            # 8) ì˜¤ë˜ëœ ë¦´ë¦¬ì¦ˆ ì •ë¦¬
            echo "ğŸ§¹ ì˜¤ë˜ëœ ë¦´ë¦¬ì¦ˆ ì •ë¦¬ ì¤‘..."
            cd "${RELEASES_DIR}" && ls -dt */ | tail -n +6 | xargs -r rm -rf --

  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [guard, prepare, perform]

    if: always()

    steps:
      - name: Notify Discord
        env:
          ENV_NAME: ${{ github.ref_name == 'main' && 'prod' || 'dev' }}
          GUARD_RESULT: ${{ needs.guard.result }}
          PREPARE_RESULT: ${{ needs.prepare.result }}
          PERFORM_RESULT: ${{ needs.perform.result }}
          RELEASE_ID: ${{ inputs.release_id || 'backup' }}
          RUN_URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ACTOR: ${{ github.actor }}
          BRANCH: ${{ github.ref_name }}
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          set -euo pipefail

          # WEBHOOK ì—†ìœ¼ë©´ ìŠ¤í… ì¢…ë£Œ
          [ -z "${WEBHOOK:-}" ] && echo "âš ï¸ DISCORD_WEBHOOK_URLì´ ê³µë°±ì´ë¯€ë¡œ ë³¸ ë‹¨ê³„ë¥¼ ìŠ¤í‚µí•©ë‹ˆë‹¤." && exit 0

          # prepare/perform ê²°ê³¼ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ìµœì¢… ì„±ê³µ/ì‹¤íŒ¨ ê²°ì •
          if [ "${GUARD_RESULT}" != "success" ]; then
            FINAL_STATUS="failure"
            REASON="guard_failed"
          elif [ "${PREPARE_RESULT}" != "success" ]; then
            FINAL_STATUS="failure"
            REASON="prepare_failed"
          elif [ "${PERFORM_RESULT}" != "success" ]; then
            FINAL_STATUS="failure"
            REASON="perform_failed"
          else
            FINAL_STATUS="success"
            REASON="ok"
          fi

          if [ "$FINAL_STATUS" = "success" ]; then
            TITLE="âœ… [FE / ${ENV_NAME}] Rollback Success"
            COLOR=5763719
          else
            TITLE="âŒ [FE / ${ENV_NAME}] Rollback Failed"
            COLOR=15548997
          fi

          NOW_ISO="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"
          JSON_PAYLOAD=$(cat <<JSON
          {
            "embeds": [{
              "title": "$TITLE",
              "url": "$RUN_URL",
              "color": $COLOR,
              "description": "$REASON",
              "fields": [
                {"name": "Release ID", "value": "\`$RELEASE_ID\`", "inline": true},
                {"name": "Actor", "value": "$ACTOR", "inline": true},
                {"name": "Branch", "value": "$BRANCH", "inline": true},
                {"name": "Prepare", "value": "\`$PREPARE_RESULT\`", "inline": true},
                {"name": "Perform", "value": "\`$PERFORM_RESULT\`", "inline": true}
              ],
              "timestamp": "$NOW_ISO"
            }]
          }
          JSON
          )

          curl -sS -X POST -H "Content-Type: application/json" --data-binary "$JSON_PAYLOAD" "$WEBHOOK" || true
